name: export-doc

on:
  push:
    # Sequence of patterns matched against refs/heads
#    branches:
#      - master

jobs:
  setup:
    name: setup
    runs-on: ubuntu-latest
    steps:

      - name: test
        run: |
          echo "github.ref = ${{ github.ref }}"
          echo "github.sha = ${{ github.sha }}"
          echo "github.ref_name = ${{ github.ref_name }}"
          echo "github.repository = ${{ github.repository }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start services
        run: docker compose up -d fake-phrasea --wait

      - name: install dependencies
        run: |
          docker compose exec -T fake-phrasea sh -c "cd databox/api && composer install"

      - name: export doc
        run: |
          docker compose exec -T fake-phrasea sh -c "php databox/api/application.php app:documentation:dump"

      - name: Build and Push image
        uses: docker/build-push-action@v6
        with:
          context: ./
          file: ./databox/api/Dockerfile
          provenance: false
          push: true
          tags: |
            ${{ env.REGISTRY_NAMESPACE }}/fake-phrasea:${{ github.ref_name }}

#
#      - name: Trigger Workflow in documentation builder Repository
#        run: |
#          # Set the required variables
#          repo_owner="alchemy-fr"
#          repo_name="phrasea-documentation-builder"
#          event_type="trigger-workflow"
#
#          curl -L \
#            -X POST \
#            -H "Accept: application/vnd.github+json" \
#            -H "Authorization: Bearer ${{ secrets.PAT }}" \
#            -H "X-GitHub-Api-Version: 2022-11-28" \
#            https://api.github.com/repos/$repo_owner/$repo_name/dispatches \
#            -d "{\"event_type\": \"$event_type\",\"client_payload\": {\"PHRASEA_BRANCH\": \"${{ github.ref }}\"}}"
